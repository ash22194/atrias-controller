function [D,C,G,B,DampingSpringTorque,EL,ER]= LagrangeModelAtriasFlight2D(q,dq)
%%%%%%  LagrangeModelAtriasFlight2D.m
%%%%  05-Sep-2012 17:49:43
%%%%
%%%% Authors(s): Grizzle
%%%%
%%%%
%%%% Model NOTATION: Spong and Vidyasagar, page 142, Eq. (6.3.12)
%%%%                 D(q)ddq + C(q,dq)*dq + G(q) + DampingSpringTorque = B*tau + EL*GroundReactionForceLeft + ER*GroundReactionForceRight
%%%%
%%%%
[g mTotal L1 L2 L3 L4 m1 m2 m3 m4 Jcm1 Jcm2 Jcm3 Jcm4 ellzcm1 ...
         ellzcm2 ellzcm3 ellzcm4 ellycm1 ellycm2 ellycm3 ellycm4 LT mT ...
         JcmT ellzcmT ellycmT mH JcmH K1 K2 Kd1 Kd2 Jrotor1 Jrotor2 ...
         Jgear1  Jgear2 R1  R2] = modelParametersAtrias_v05;
%%%%
%%%%[g mTotal L1 L2 L3 L4 m1 m2 m3 m4 Jcm1 Jcm2 Jcm3 Jcm4 ellzcm1 ellzcm2 ellzcm3 ellzcm4 ellycm1 ellycm2 ellycm3 ellycm4 LT mT JcmT ellzcmT ellycmT mH JcmH K1 K2 Kd1 Kd2 Jrotor1 Jrotor2 Jgear1  Jgear2 R1  R2] = modelParametersAtrias_v05;
%%%%
%%%%
yH=q(1);  dyH=dq(1);
zH=q(2);  dzH=dq(2);
qT=q(3);  dqT=dq(3);
q1=q(4);  dq1=dq(4);
q2=q(5);  dq2=dq(5);
qgr1=q(6);  dqgr1=dq(6);
qgr2=q(7);  dqgr2=dq(7);
q1L=q(8);  dq1L=dq(8);
q2L=q(9);  dq2L=dq(9);
qgr1L=q(10);  dqgr1L=dq(10);
qgr2L=q(11);  dqgr2L=dq(11);
%%%%
%%%%
D=zeros(11,11);
D(1,1)=2*m1 + 2*m2 + 2*m3 + 2*m4 + mH + mT;
D(1,3)=- ellzcmT*mT*cos(qT) - ellycmT*mT*sin(qT) - L1*m3*...
         cos(q1 + qT) - L1*m3*cos(q1L + qT) - L2*m4*cos(q2 + qT) - L2*m4*...
         cos(q2L + qT) - ellzcm1*m1*cos(q1 + qT) - ellzcm1*m1*...
         cos(q1L + qT) - ellzcm2*m2*cos(q2 + qT) - ellzcm2*m2*...
         cos(q2L + qT) - ellzcm3*m3*cos(q2 + qT) - ellzcm4*m4*...
         cos(q1 + qT) - ellzcm3*m3*cos(q2L + qT) - ellzcm4*m4*...
         cos(q1L + qT) - ellycm1*m1*sin(q1 + qT) - ellycm1*m1*...
         sin(q1L + qT) - ellycm2*m2*sin(q2 + qT) - ellycm2*m2*...
         sin(q2L + qT) - ellycm3*m3*sin(q2 + qT) - ellycm4*m4*...
         sin(q1 + qT) - ellycm3*m3*sin(q2L + qT) - ellycm4*m4*...
         sin(q1L + qT);
D(1,4)=- L1*m3*cos(q1 + qT) - ellzcm1*m1*cos(q1 + qT) - ellzcm4*...
         m4*cos(q1 + qT) - ellycm1*m1*sin(q1 + qT) - ellycm4*m4*...
         sin(q1 + qT);
D(1,5)=- L2*m4*cos(q2 + qT) - ellzcm2*m2*cos(q2 + qT) - ellzcm3*...
         m3*cos(q2 + qT) - ellycm2*m2*sin(q2 + qT) - ellycm3*m3*...
         sin(q2 + qT);
D(1,8)=- L1*m3*cos(q1L + qT) - ellzcm1*m1*...
         cos(q1L + qT) - ellzcm4*m4*cos(q1L + qT) - ellycm1*m1*...
         sin(q1L + qT) - ellycm4*m4*sin(q1L + qT);
D(1,9)=- L2*m4*cos(q2L + qT) - ellzcm2*m2*...
         cos(q2L + qT) - ellzcm3*m3*cos(q2L + qT) - ellycm2*m2*...
         sin(q2L + qT) - ellycm3*m3*sin(q2L + qT);
D(2,2)=2*m1 + 2*m2 + 2*m3 + 2*m4 + mH + mT;
D(2,3)=ellycmT*mT*cos(qT) - ellzcmT*mT*sin(qT) - L1*m3*...
         sin(q1 + qT) - L1*m3*sin(q1L + qT) - L2*m4*sin(q2 + qT) - L2*m4*...
         sin(q2L + qT) + ellycm1*m1*cos(q1 + qT) + ellycm1*m1*...
         cos(q1L + qT) + ellycm2*m2*cos(q2 + qT) + ellycm2*m2*...
         cos(q2L + qT) + ellycm3*m3*cos(q2 + qT) + ellycm4*m4*...
         cos(q1 + qT) + ellycm3*m3*cos(q2L + qT) + ellycm4*m4*...
         cos(q1L + qT) - ellzcm1*m1*sin(q1 + qT) - ellzcm1*m1*...
         sin(q1L + qT) - ellzcm2*m2*sin(q2 + qT) - ellzcm2*m2*...
         sin(q2L + qT) - ellzcm3*m3*sin(q2 + qT) - ellzcm4*m4*...
         sin(q1 + qT) - ellzcm3*m3*sin(q2L + qT) - ellzcm4*m4*...
         sin(q1L + qT);
D(2,4)=ellycm1*m1*cos(q1 + qT) - L1*m3*sin(q1 + qT) + ellycm4*m4*...
         cos(q1 + qT) - ellzcm1*m1*sin(q1 + qT) - ellzcm4*m4*sin(q1 + qT);
D(2,5)=ellycm2*m2*cos(q2 + qT) - L2*m4*sin(q2 + qT) + ellycm3*m3*...
         cos(q2 + qT) - ellzcm2*m2*sin(q2 + qT) - ellzcm3*m3*sin(q2 + qT);
D(2,8)=ellycm1*m1*cos(q1L + qT) - L1*m3*sin(q1L + qT) + ellycm4*...
         m4*cos(q1L + qT) - ellzcm1*m1*sin(q1L + qT) - ellzcm4*m4*...
         sin(q1L + qT);
D(2,9)=ellycm2*m2*cos(q2L + qT) - L2*m4*sin(q2L + qT) + ellycm3*...
         m3*cos(q2L + qT) - ellzcm2*m2*sin(q2L + qT) - ellzcm3*m3*...
         sin(q2L + qT);
D(3,1)=- ellzcmT*mT*cos(qT) - ellycmT*mT*sin(qT) - L1*m3*...
         cos(q1 + qT) - L1*m3*cos(q1L + qT) - L2*m4*cos(q2 + qT) - L2*m4*...
         cos(q2L + qT) - ellzcm1*m1*cos(q1 + qT) - ellzcm1*m1*...
         cos(q1L + qT) - ellzcm2*m2*cos(q2 + qT) - ellzcm2*m2*...
         cos(q2L + qT) - ellzcm3*m3*cos(q2 + qT) - ellzcm4*m4*...
         cos(q1 + qT) - ellzcm3*m3*cos(q2L + qT) - ellzcm4*m4*...
         cos(q1L + qT) - ellycm1*m1*sin(q1 + qT) - ellycm1*m1*...
         sin(q1L + qT) - ellycm2*m2*sin(q2 + qT) - ellycm2*m2*...
         sin(q2L + qT) - ellycm3*m3*sin(q2 + qT) - ellycm4*m4*...
         sin(q1 + qT) - ellycm3*m3*sin(q2L + qT) - ellycm4*m4*...
         sin(q1L + qT);
D(3,2)=ellycmT*mT*cos(qT) - ellzcmT*mT*sin(qT) - L1*m3*...
         sin(q1 + qT) - L1*m3*sin(q1L + qT) - L2*m4*sin(q2 + qT) - L2*m4*...
         sin(q2L + qT) + ellycm1*m1*cos(q1 + qT) + ellycm1*m1*...
         cos(q1L + qT) + ellycm2*m2*cos(q2 + qT) + ellycm2*m2*...
         cos(q2L + qT) + ellycm3*m3*cos(q2 + qT) + ellycm4*m4*...
         cos(q1 + qT) + ellycm3*m3*cos(q2L + qT) + ellycm4*m4*...
         cos(q1L + qT) - ellzcm1*m1*sin(q1 + qT) - ellzcm1*m1*...
         sin(q1L + qT) - ellzcm2*m2*sin(q2 + qT) - ellzcm2*m2*...
         sin(q2L + qT) - ellzcm3*m3*sin(q2 + qT) - ellzcm4*m4*...
         sin(q1 + qT) - ellzcm3*m3*sin(q2L + qT) - ellzcm4*m4*...
         sin(q1L + qT);
D(3,3)=2*Jcm1 + 2*Jcm2 + 2*Jcm3 + 2*Jcm4 + JcmH + JcmT + 2*...
         Jgear1 + 2*Jgear2 + 2*Jrotor1 + 2*Jrotor2 + 2*L1^2*m3 + 2*L2^2*...
         m4 + 2*ellycm1^2*m1 + 2*ellzcm1^2*m1 + 2*ellycm2^2*m2 + 2*...
         ellzcm2^2*m2 + 2*ellycm3^2*m3 + 2*ellzcm3^2*m3 + 2*ellycm4^2*...
         m4 + 2*ellzcm4^2*m4 + ellycmT^2*mT + ellzcmT^2*mT + 2*L1*ellzcm3*...
         m3*cos(q1 - q2) + 2*L1*ellzcm3*m3*cos(q1L - q2L) + 2*L2*ellzcm4*...
         m4*cos(q1 - q2) + 2*L2*ellzcm4*m4*cos(q1L - q2L) - 2*L1*ellycm3*...
         m3*sin(q1 - q2) - 2*L1*ellycm3*m3*sin(q1L - q2L) + 2*L2*ellycm4*...
         m4*sin(q1 - q2) + 2*L2*ellycm4*m4*sin(q1L - q2L);
D(3,4)=Jcm1 + Jcm4 + L1^2*m3 + ellycm1^2*m1 + ellzcm1^2*...
         m1 + ellycm4^2*m4 + ellzcm4^2*m4 + L1*ellzcm3*m3*...
         cos(q1 - q2) + L2*ellzcm4*m4*cos(q1 - q2) - L1*ellycm3*m3*...
         sin(q1 - q2) + L2*ellycm4*m4*sin(q1 - q2);
D(3,5)=Jcm2 + Jcm3 + L2^2*m4 + ellycm2^2*m2 + ellzcm2^2*...
         m2 + ellycm3^2*m3 + ellzcm3^2*m3 + L1*ellzcm3*m3*...
         cos(q1 - q2) + L2*ellzcm4*m4*cos(q1 - q2) - L1*ellycm3*m3*...
         sin(q1 - q2) + L2*ellycm4*m4*sin(q1 - q2);
D(3,6)=Jgear1 + Jrotor1*R1;
D(3,7)=Jgear2 + Jrotor2*R2;
D(3,8)=Jcm1 + Jcm4 + L1^2*m3 + ellycm1^2*m1 + ellzcm1^2*...
         m1 + ellycm4^2*m4 + ellzcm4^2*m4 + L1*ellzcm3*m3*...
         cos(q1L - q2L) + L2*ellzcm4*m4*cos(q1L - q2L) - L1*ellycm3*m3*...
         sin(q1L - q2L) + L2*ellycm4*m4*sin(q1L - q2L);
D(3,9)=Jcm2 + Jcm3 + L2^2*m4 + ellycm2^2*m2 + ellzcm2^2*...
         m2 + ellycm3^2*m3 + ellzcm3^2*m3 + L1*ellzcm3*m3*...
         cos(q1L - q2L) + L2*ellzcm4*m4*cos(q1L - q2L) - L1*ellycm3*m3*...
         sin(q1L - q2L) + L2*ellycm4*m4*sin(q1L - q2L);
D(3,10)=Jgear1 + Jrotor1*R1;
D(3,11)=Jgear2 + Jrotor2*R2;
D(4,1)=- L1*m3*cos(q1 + qT) - ellzcm1*m1*cos(q1 + qT) - ellzcm4*...
         m4*cos(q1 + qT) - ellycm1*m1*sin(q1 + qT) - ellycm4*m4*...
         sin(q1 + qT);
D(4,2)=ellycm1*m1*cos(q1 + qT) - L1*m3*sin(q1 + qT) + ellycm4*m4*...
         cos(q1 + qT) - ellzcm1*m1*sin(q1 + qT) - ellzcm4*m4*sin(q1 + qT);
D(4,3)=Jcm1 + Jcm4 + L1^2*m3 + ellycm1^2*m1 + ellzcm1^2*...
         m1 + ellycm4^2*m4 + ellzcm4^2*m4 + L1*ellzcm3*m3*...
         cos(q1 - q2) + L2*ellzcm4*m4*cos(q1 - q2) - L1*ellycm3*m3*...
         sin(q1 - q2) + L2*ellycm4*m4*sin(q1 - q2);
D(4,4)=m3*L1^2 + m1*ellycm1^2 + m1*ellzcm1^2 + m4*ellycm4^2 + m4*...
         ellzcm4^2 + Jcm1 + Jcm4;
D(4,5)=L1*ellzcm3*m3*cos(q1 - q2) + L2*ellzcm4*m4*...
         cos(q1 - q2) - L1*ellycm3*m3*sin(q1 - q2) + L2*ellycm4*m4*...
         sin(q1 - q2);
D(5,1)=- L2*m4*cos(q2 + qT) - ellzcm2*m2*cos(q2 + qT) - ellzcm3*...
         m3*cos(q2 + qT) - ellycm2*m2*sin(q2 + qT) - ellycm3*m3*...
         sin(q2 + qT);
D(5,2)=ellycm2*m2*cos(q2 + qT) - L2*m4*sin(q2 + qT) + ellycm3*m3*...
         cos(q2 + qT) - ellzcm2*m2*sin(q2 + qT) - ellzcm3*m3*sin(q2 + qT);
D(5,3)=Jcm2 + Jcm3 + L2^2*m4 + ellycm2^2*m2 + ellzcm2^2*...
         m2 + ellycm3^2*m3 + ellzcm3^2*m3 + L1*ellzcm3*m3*...
         cos(q1 - q2) + L2*ellzcm4*m4*cos(q1 - q2) - L1*ellycm3*m3*...
         sin(q1 - q2) + L2*ellycm4*m4*sin(q1 - q2);
D(5,4)=L1*ellzcm3*m3*cos(q1 - q2) + L2*ellzcm4*m4*...
         cos(q1 - q2) - L1*ellycm3*m3*sin(q1 - q2) + L2*ellycm4*m4*...
         sin(q1 - q2);
D(5,5)=m4*L2^2 + m2*ellycm2^2 + m3*ellycm3^2 + m2*ellzcm2^2 + m3*...
         ellzcm3^2 + Jcm2 + Jcm3;
D(6,3)=Jgear1 + Jrotor1*R1;
D(6,6)=Jrotor1*R1^2 + Jgear1;
D(7,3)=Jgear2 + Jrotor2*R2;
D(7,7)=Jrotor2*R2^2 + Jgear2;
D(8,1)=- L1*m3*cos(q1L + qT) - ellzcm1*m1*...
         cos(q1L + qT) - ellzcm4*m4*cos(q1L + qT) - ellycm1*m1*...
         sin(q1L + qT) - ellycm4*m4*sin(q1L + qT);
D(8,2)=ellycm1*m1*cos(q1L + qT) - L1*m3*sin(q1L + qT) + ellycm4*...
         m4*cos(q1L + qT) - ellzcm1*m1*sin(q1L + qT) - ellzcm4*m4*...
         sin(q1L + qT);
D(8,3)=Jcm1 + Jcm4 + L1^2*m3 + ellycm1^2*m1 + ellzcm1^2*...
         m1 + ellycm4^2*m4 + ellzcm4^2*m4 + L1*ellzcm3*m3*...
         cos(q1L - q2L) + L2*ellzcm4*m4*cos(q1L - q2L) - L1*ellycm3*m3*...
         sin(q1L - q2L) + L2*ellycm4*m4*sin(q1L - q2L);
D(8,8)=m3*L1^2 + m1*ellycm1^2 + m1*ellzcm1^2 + m4*ellycm4^2 + m4*...
         ellzcm4^2 + Jcm1 + Jcm4;
D(8,9)=L1*ellzcm3*m3*cos(q1L - q2L) + L2*ellzcm4*m4*...
         cos(q1L - q2L) - L1*ellycm3*m3*sin(q1L - q2L) + L2*ellycm4*m4*...
         sin(q1L - q2L);
D(9,1)=- L2*m4*cos(q2L + qT) - ellzcm2*m2*...
         cos(q2L + qT) - ellzcm3*m3*cos(q2L + qT) - ellycm2*m2*...
         sin(q2L + qT) - ellycm3*m3*sin(q2L + qT);
D(9,2)=ellycm2*m2*cos(q2L + qT) - L2*m4*sin(q2L + qT) + ellycm3*...
         m3*cos(q2L + qT) - ellzcm2*m2*sin(q2L + qT) - ellzcm3*m3*...
         sin(q2L + qT);
D(9,3)=Jcm2 + Jcm3 + L2^2*m4 + ellycm2^2*m2 + ellzcm2^2*...
         m2 + ellycm3^2*m3 + ellzcm3^2*m3 + L1*ellzcm3*m3*...
         cos(q1L - q2L) + L2*ellzcm4*m4*cos(q1L - q2L) - L1*ellycm3*m3*...
         sin(q1L - q2L) + L2*ellycm4*m4*sin(q1L - q2L);
D(9,8)=L1*ellzcm3*m3*cos(q1L - q2L) + L2*ellzcm4*m4*...
         cos(q1L - q2L) - L1*ellycm3*m3*sin(q1L - q2L) + L2*ellycm4*m4*...
         sin(q1L - q2L);
D(9,9)=m4*L2^2 + m2*ellycm2^2 + m3*ellycm3^2 + m2*ellzcm2^2 + m3*...
         ellzcm3^2 + Jcm2 + Jcm3;
D(10,3)=Jgear1 + Jrotor1*R1;
D(10,10)=Jrotor1*R1^2 + Jgear1;
D(11,3)=Jgear2 + Jrotor2*R2;
D(11,11)=Jrotor2*R2^2 + Jgear2;
%%%%
%%%%
%%%%
%%%%
C=zeros(11,11);
C(1,3)=dq1*(L1*m3*sin(q1 + qT) - ellycm1*m1*...
         cos(q1 + qT) - ellycm4*m4*cos(q1 + qT) + ellzcm1*m1*...
         sin(q1 + qT) + ellzcm4*m4*sin(q1 + qT)) + dq1L*(L1*m3*...
         sin(q1L + qT) - ellycm1*m1*cos(q1L + qT) - ellycm4*m4*...
         cos(q1L + qT) + ellzcm1*m1*sin(q1L + qT) + ellzcm4*m4*...
         sin(q1L + qT)) + dq2*(L2*m4*sin(q2 + qT) - ellycm2*m2*...
         cos(q2 + qT) - ellycm3*m3*cos(q2 + qT) + ellzcm2*m2*...
         sin(q2 + qT) + ellzcm3*m3*sin(q2 + qT)) + dq2L*(L2*m4*...
         sin(q2L + qT) - ellycm2*m2*cos(q2L + qT) - ellycm3*m3*...
         cos(q2L + qT) + ellzcm2*m2*sin(q2L + qT) + ellzcm3*m3*...
         sin(q2L + qT)) + dqT*(ellzcmT*mT*sin(qT) - ellycmT*mT*...
         cos(qT) + L1*m3*sin(q1 + qT) + L1*m3*sin(q1L + qT) + L2*m4*...
         sin(q2 + qT) + L2*m4*sin(q2L + qT) - ellycm1*m1*...
         cos(q1 + qT) - ellycm1*m1*cos(q1L + qT) - ellycm2*m2*...
         cos(q2 + qT) - ellycm2*m2*cos(q2L + qT) - ellycm3*m3*...
         cos(q2 + qT) - ellycm4*m4*cos(q1 + qT) - ellycm3*m3*...
         cos(q2L + qT) - ellycm4*m4*cos(q1L + qT) + ellzcm1*m1*...
         sin(q1 + qT) + ellzcm1*m1*sin(q1L + qT) + ellzcm2*m2*...
         sin(q2 + qT) + ellzcm2*m2*sin(q2L + qT) + ellzcm3*m3*...
         sin(q2 + qT) + ellzcm4*m4*sin(q1 + qT) + ellzcm3*m3*...
         sin(q2L + qT) + ellzcm4*m4*sin(q1L + qT));
C(1,4)=(dq1 + dqT)*(L1*m3*sin(q1 + qT) - ellycm1*m1*...
         cos(q1 + qT) - ellycm4*m4*cos(q1 + qT) + ellzcm1*m1*...
         sin(q1 + qT) + ellzcm4*m4*sin(q1 + qT));
C(1,5)=(dq2 + dqT)*(L2*m4*sin(q2 + qT) - ellycm2*m2*...
         cos(q2 + qT) - ellycm3*m3*cos(q2 + qT) + ellzcm2*m2*...
         sin(q2 + qT) + ellzcm3*m3*sin(q2 + qT));
C(1,8)=(dq1L + dqT)*(L1*m3*sin(q1L + qT) - ellycm1*m1*...
         cos(q1L + qT) - ellycm4*m4*cos(q1L + qT) + ellzcm1*m1*...
         sin(q1L + qT) + ellzcm4*m4*sin(q1L + qT));
C(1,9)=(dq2L + dqT)*(L2*m4*sin(q2L + qT) - ellycm2*m2*...
         cos(q2L + qT) - ellycm3*m3*cos(q2L + qT) + ellzcm2*m2*...
         sin(q2L + qT) + ellzcm3*m3*sin(q2L + qT));
C(2,3)=- dqT*(ellzcmT*mT*cos(qT) + ellycmT*mT*sin(qT) + L1*m3*...
         cos(q1 + qT) + L1*m3*cos(q1L + qT) + L2*m4*cos(q2 + qT) + L2*m4*...
         cos(q2L + qT) + ellzcm1*m1*cos(q1 + qT) + ellzcm1*m1*...
         cos(q1L + qT) + ellzcm2*m2*cos(q2 + qT) + ellzcm2*m2*...
         cos(q2L + qT) + ellzcm3*m3*cos(q2 + qT) + ellzcm4*m4*...
         cos(q1 + qT) + ellzcm3*m3*cos(q2L + qT) + ellzcm4*m4*...
         cos(q1L + qT) + ellycm1*m1*sin(q1 + qT) + ellycm1*m1*...
         sin(q1L + qT) + ellycm2*m2*sin(q2 + qT) + ellycm2*m2*...
         sin(q2L + qT) + ellycm3*m3*sin(q2 + qT) + ellycm4*m4*...
         sin(q1 + qT) + ellycm3*m3*sin(q2L + qT) + ellycm4*m4*...
         sin(q1L + qT)) - dq1*(L1*m3*cos(q1 + qT) + ellzcm1*m1*...
         cos(q1 + qT) + ellzcm4*m4*cos(q1 + qT) + ellycm1*m1*...
         sin(q1 + qT) + ellycm4*m4*sin(q1 + qT)) - dq1L*(L1*m3*...
         cos(q1L + qT) + ellzcm1*m1*cos(q1L + qT) + ellzcm4*m4*...
         cos(q1L + qT) + ellycm1*m1*sin(q1L + qT) + ellycm4*m4*...
         sin(q1L + qT)) - dq2*(L2*m4*cos(q2 + qT) + ellzcm2*m2*...
         cos(q2 + qT) + ellzcm3*m3*cos(q2 + qT) + ellycm2*m2*...
         sin(q2 + qT) + ellycm3*m3*sin(q2 + qT)) - dq2L*(L2*m4*...
         cos(q2L + qT) + ellzcm2*m2*cos(q2L + qT) + ellzcm3*m3*...
         cos(q2L + qT) + ellycm2*m2*sin(q2L + qT) + ellycm3*m3*...
         sin(q2L + qT));
C(2,4)=-(dq1 + dqT)*(L1*m3*cos(q1 + qT) + ellzcm1*m1*...
         cos(q1 + qT) + ellzcm4*m4*cos(q1 + qT) + ellycm1*m1*...
         sin(q1 + qT) + ellycm4*m4*sin(q1 + qT));
C(2,5)=-(dq2 + dqT)*(L2*m4*cos(q2 + qT) + ellzcm2*m2*...
         cos(q2 + qT) + ellzcm3*m3*cos(q2 + qT) + ellycm2*m2*...
         sin(q2 + qT) + ellycm3*m3*sin(q2 + qT));
C(2,8)=-(dq1L + dqT)*(L1*m3*cos(q1L + qT) + ellzcm1*m1*...
         cos(q1L + qT) + ellzcm4*m4*cos(q1L + qT) + ellycm1*m1*...
         sin(q1L + qT) + ellycm4*m4*sin(q1L + qT));
C(2,9)=-(dq2L + dqT)*(L2*m4*cos(q2L + qT) + ellzcm2*m2*...
         cos(q2L + qT) + ellzcm3*m3*cos(q2L + qT) + ellycm2*m2*...
         sin(q2L + qT) + ellycm3*m3*sin(q2L + qT));
C(3,3)=dq2*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2)) - dq1*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2)) - dq1L*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
         m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
         sin(q1L - q2L)) + dq2L*(L1*ellycm3*m3*cos(q1L - q2L) - L2*...
         ellycm4*m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*...
         ellzcm4*m4*sin(q1L - q2L));
C(3,4)=-(dq1 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2));
C(3,5)=(dq2 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2));
C(3,8)=-(dq1L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
         m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
         sin(q1L - q2L));
C(3,9)=(dq2L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
         m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
         sin(q1L - q2L));
C(4,3)=(dq2 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2));
C(4,5)=(dq2 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2));
C(5,3)=-(dq1 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2));
C(5,4)=-(dq1 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
         cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
         sin(q1 - q2));
C(8,3)=(dq2L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
         m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
         sin(q1L - q2L));
C(8,9)=(dq2L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
         m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
         sin(q1L - q2L));
C(9,3)=-(dq1L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
         m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
         sin(q1L - q2L));
C(9,8)=-(dq1L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
         m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
         sin(q1L - q2L));
%%%%
%%%%
%%%%
%%%%
G=zeros(11,1);
G(1)=0;
G(2)=g*(2*m1 + 2*m2 + 2*m3 + 2*m4 + mH + mT);
G(3)=g*m1*(ellycm1*cos(q1 + qT) - ellzcm1*sin(q1 + qT)) + g*m1*...
         (ellycm1*cos(q1L + qT) - ellzcm1*sin(q1L + qT)) + g*m2*(ellycm2*...
         cos(q2 + qT) - ellzcm2*sin(q2 + qT)) + g*m2*(ellycm2*...
         cos(q2L + qT) - ellzcm2*sin(q2L + qT)) + g*mT*(ellycmT*...
         cos(qT) - ellzcmT*sin(qT)) - g*m3*(L1*sin(q1 + qT) - ellycm3*...
         cos(q2 + qT) + ellzcm3*sin(q2 + qT)) - g*m3*(L1*...
         sin(q1L + qT) - ellycm3*cos(q2L + qT) + ellzcm3*...
         sin(q2L + qT)) - g*m4*(L2*sin(q2 + qT) - ellycm4*...
         cos(q1 + qT) + ellzcm4*sin(q1 + qT)) - g*m4*(L2*...
         sin(q2L + qT) - ellycm4*cos(q1L + qT) + ellzcm4*sin(q1L + qT));
G(4)=g*(m1*(ellycm1*cos(q1 + qT) - ellzcm1*sin(q1 + qT)) + m4*...
         (ellycm4*cos(q1 + qT) - ellzcm4*sin(q1 + qT)) - L1*m3*...
         sin(q1 + qT)) + (K1*(2*q1 - 2*qgr1))/2;
G(5)=g*(m2*(ellycm2*cos(q2 + qT) - ellzcm2*sin(q2 + qT)) + m3*...
         (ellycm3*cos(q2 + qT) - ellzcm3*sin(q2 + qT)) - L2*m4*...
         sin(q2 + qT)) + (K2*(2*q2 - 2*qgr2))/2;
G(6)=-K1*(q1 - qgr1);
G(7)=-K2*(q2 - qgr2);
G(8)=g*(m1*(ellycm1*cos(q1L + qT) - ellzcm1*sin(q1L + qT)) + m4*...
         (ellycm4*cos(q1L + qT) - ellzcm4*sin(q1L + qT)) - L1*m3*...
         sin(q1L + qT)) + (K1*(2*q1L - 2*qgr1L))/2;
G(9)=g*(m2*(ellycm2*cos(q2L + qT) - ellzcm2*sin(q2L + qT)) + m3*...
         (ellycm3*cos(q2L + qT) - ellzcm3*sin(q2L + qT)) - L2*m4*...
         sin(q2L + qT)) + (K2*(2*q2L - 2*qgr2L))/2;
G(10)=-K1*(q1L - qgr1L);
G(11)=-K2*(q2L - qgr2L);
%%%%
%%%%
%%%%
%%%%
B=zeros(11,4);
B(6,1)=R1;
B(7,2)=R2;
B(10,3)=R1;
B(11,4)=R2;
%%%%
%%%%
DampingSpringTorque=zeros(11,1);
DampingSpringTorque(1)=0;
DampingSpringTorque(2)=0;
DampingSpringTorque(3)=0;
DampingSpringTorque(4)=Kd1*(dq1 - dqgr1);
DampingSpringTorque(5)=Kd2*(dq2 - dqgr2);
DampingSpringTorque(6)=-Kd1*(dq1 - dqgr1);
DampingSpringTorque(7)=-Kd2*(dq2 - dqgr2);
DampingSpringTorque(8)=Kd1*(dq1L - dqgr1L);
DampingSpringTorque(9)=Kd2*(dq2L - dqgr2L);
DampingSpringTorque(10)=-Kd1*(dq1L - dqgr1L);
DampingSpringTorque(11)=-Kd2*(dq2L - dqgr2L);
%%%%
%%%%
EL=zeros(11,2);
EL(1,1)=1;
EL(2,2)=1;
EL(3,1)=- L2*cos(q2L + qT) - L4*cos(q1L + qT);
EL(3,2)=- L2*sin(q2L + qT) - L4*sin(q1L + qT);
EL(8,1)=-L4*cos(q1L + qT);
EL(8,2)=-L4*sin(q1L + qT);
EL(9,1)=-L2*cos(q2L + qT);
EL(9,2)=-L2*sin(q2L + qT);
%%%%
%%%%
ER=zeros(11,2);
ER(1,1)=1;
ER(2,2)=1;
ER(3,1)=- L2*cos(q2 + qT) - L4*cos(q1 + qT);
ER(3,2)=- L2*sin(q2 + qT) - L4*sin(q1 + qT);
ER(4,1)=-L4*cos(q1 + qT);
ER(4,2)=-L4*sin(q1 + qT);
ER(5,1)=-L2*cos(q2 + qT);
ER(5,2)=-L2*sin(q2 + qT);
return